<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="description" content="Wake Lab" />
  <meta name="theme-color" content="#1a1a1a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Wake" />
  <!-- Content Security Policy to help prevent extension injection issues -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: blob: https:; font-src 'self' data: https:; connect-src 'self' https: wss: ws:; media-src 'self' blob: https:;">
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/app_icon.png" />
  <link rel="apple-touch-icon" href="/app_icon.png" />
  <title>Wake lab</title>
  <style>
    /* Critical: full viewport height chain for all routes (login + app) */
    html {
      height: 100%;
    }
    body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      height: 100%;
      background-color: #1a1a1a;
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }
    #root {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 100vh;
      min-height: 100svh;
    }
    #root > * {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    /* Loading screen */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #1a1a1a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #loading-screen.hidden {
      display: none;
    }

    .loading-logo {
      width: 120px;
      height: auto;
      margin-bottom: 24px;
      opacity: 0.9;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: rgba(191, 168, 77, 1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Hide scrollbar but allow scrolling */
    ::-webkit-scrollbar {
      width: 0px;
      background: transparent;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="loading-screen">
    <img src="/assets/wake-logo-new.png" alt="Wake" class="loading-logo" />
    <div class="loading-spinner"></div>
  </div>

  <script>
    // Register Service Worker - SKIP FOR LOGIN ROUTE
    // Only register if /sw.js is served as JS (not as index.html fallback - fixes "unsupported MIME type text/html")
    if ('serviceWorker' in navigator && window.location.pathname !== '/login') {
      window.addEventListener('load', () => {
        fetch('/sw.js', { method: 'HEAD' })
          .then(function (res) {
            var ct = res.headers.get('content-type') || '';
            if (ct.indexOf('javascript') === -1 && ct.indexOf('ecmascript') === -1) {
              return;
            }
            return navigator.serviceWorker.register('/sw.js');
          })
          .then(function () {})
          .catch(function () {});
      });
    } else if (window.location.pathname === '/login') {
      // Unregister service worker for login route
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        registrations.forEach((registration) => {
          registration.unregister();
        });
      });
    }

    // Hide loading screen when app loads
    window.addEventListener('load', () => {
      setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
          loadingScreen.classList.add('hidden');
        }
      }, 500);
    });

    // Prevent zoom on double tap (iOS)
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (event) => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);

    // Pull-to-refresh: left to browser default (no document-level prevention)
    // so vertical scroll works in the in-app ScrollView and pull-to-refresh remains a feature

    // iOS PWA viewport fix: 100vh/100svh use "small" viewport leaving a bottom gap. Run before React so we
    // catch standalone even when matchMedia/navigator.standalone report late. Uses all detection methods,
    // delayed re-checks, and display-mode listener.
    (function() {
      function isStandalone() {
        if (window.matchMedia) {
          if (window.matchMedia('(display-mode: standalone)').matches) return true;
          if (window.matchMedia('(display-mode: minimal-ui)').matches) return true;
        }
        return !!(window.navigator && window.navigator.standalone === true);
      }
      function isIOS() {
        return /iPhone|iPad|iPod/.test(navigator.userAgent || '');
      }
      function shouldApplyPWAViewportFix() {
        if (isStandalone()) return true;
        if (!isIOS() || !window.screen || !window.screen.availHeight) return false;
        var ih = window.innerHeight || 0;
        if (window.visualViewport && window.visualViewport.height) {
          ih = Math.max(ih, window.visualViewport.height);
        }
        return ih >= window.screen.availHeight - 2;
      }
      function getCanonicalHeight() {
        var h = window.innerHeight || 0;
        if (window.visualViewport && window.visualViewport.height) {
          h = Math.max(h, window.visualViewport.height);
        }
        if (isIOS() && window.screen && window.screen.availHeight) {
          var nearFull = h >= window.screen.availHeight - 2;
          if (isStandalone() || nearFull) {
            h = Math.max(h, window.screen.availHeight);
          }
        }
        return Math.round(h);
      }
      function getCanonicalWidth() {
        if (window.visualViewport) {
          return Math.round(window.visualViewport.width * window.visualViewport.scale);
        }
        return document.documentElement.clientWidth || window.innerWidth || 0;
      }
      function setLayoutViewportCSSVars() {
        var w = getCanonicalWidth();
        var h = getCanonicalHeight();
        if (w > 0 && h > 0) {
          document.documentElement.style.setProperty('--layout-width-px', w + 'px');
          document.documentElement.style.setProperty('--layout-height-px', h + 'px');
        }
      }
      function applyPWAViewportHeight() {
        setLayoutViewportCSSVars();
        if (!shouldApplyPWAViewportFix()) return;
        var root = document.getElementById('root');
        if (!root) return;
        var h = getCanonicalHeight();
        if (h <= 0) return;
        document.documentElement.style.setProperty('height', h + 'px');
        document.documentElement.style.setProperty('min-height', h + 'px');
        document.body.style.setProperty('height', h + 'px');
        document.body.style.setProperty('min-height', h + 'px');
        root.style.setProperty('height', h + 'px');
        root.style.setProperty('min-height', h + 'px');
        root.style.setProperty('max-height', h + 'px');
      }
      applyPWAViewportHeight();
      setTimeout(applyPWAViewportHeight, 100);
      setTimeout(applyPWAViewportHeight, 300);
      setTimeout(applyPWAViewportHeight, 800);
      window.addEventListener('resize', applyPWAViewportHeight);
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', applyPWAViewportHeight);
        window.visualViewport.addEventListener('scroll', applyPWAViewportHeight);
      }
      var mq = window.matchMedia && window.matchMedia('(display-mode: standalone)');
      if (mq && mq.addEventListener) {
        mq.addEventListener('change', function(e) { if (e.matches) applyPWAViewportHeight(); });
      }
      var mqMin = window.matchMedia && window.matchMedia('(display-mode: minimal-ui)');
      if (mqMin && mqMin.addEventListener) {
        mqMin.addEventListener('change', function(e) { if (e.matches) applyPWAViewportHeight(); });
      }
    })();
  </script>
  <!-- EXPO_BUNDLE_SCRIPT: replaced by build script with actual bundle script tag -->
</body>
</html>

