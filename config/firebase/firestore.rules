rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check if user is the owner of a resource
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Check user role (with safe fallback)
    function getUserRole() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', 'user')
        : 'user';
    }
    
    // Check if user is admin
    function isAdmin() {
      return getUserRole() == 'admin';
    }
    
    // Check if user is creator
    function isCreator() {
      return getUserRole() == 'creator' || isAdmin();
    }
    
    // Creator can read/update a user doc if that user is their one-on-one client (creator_client_access doc exists)
    function creatorHasClientAccess(userId) {
      return isCreator() && exists(/databases/$(database)/documents/creator_client_access/$(request.auth.uid + '_' + userId));
    }
    
    // ============================================
    // USER DATA
    // ============================================
    
    // Users collection - owner, admin, or creator (for their clients) can read/update
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin() || creatorHasClientAccess(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId) || isAdmin() || creatorHasClientAccess(userId);
      allow delete: if isOwner(userId) || isAdmin();
      
      // Exercise history subcollections
      match /exerciseHistory/{exerciseKey} {
        allow read, write: if isOwner(userId);
      }
      
      // Session history subcollections (creator can read for completion indicator on calendar)
      match /sessionHistory/{sessionId} {
        allow read: if isOwner(userId) || isAdmin() || creatorHasClientAccess(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // Creator-client access: doc id = creatorId_userId; allows creator to read/update that user's document (e.g. set access end date)
    match /creator_client_access/{accessId} {
      allow read: if isSignedIn() && resource.data.creatorId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid && accessId == request.auth.uid + '_' + request.resource.data.userId;
      allow update: if isSignedIn() && resource.data.creatorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.creatorId == request.auth.uid;
    }
    
    // ============================================
    // ONE-ON-ONE CLIENTS
    // ============================================
    
    // One-on-one clients collection
    match /one_on_one_clients/{clientDocId} {
      // Creator can read/write their own clients
      // Client can read their own record
      allow read: if isSignedIn() && (
        resource.data.creatorId == request.auth.uid || 
        resource.data.clientUserId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isSignedIn() && isCreator() && request.resource.data.creatorId == request.auth.uid;
      allow update: if isSignedIn() && (
        resource.data.creatorId == request.auth.uid || 
        isAdmin()
      );
      allow delete: if isSignedIn() && (
        resource.data.creatorId == request.auth.uid || 
        isAdmin()
      );
    }
    
    // ============================================
    // COURSE CONTENT
    // ============================================
    
    // Courses - All authenticated users can read
    match /courses/{courseId} {
      allow read: if isSignedIn();
      
      // Only creators can create courses
      allow create: if isCreator();
      
      // Only course creator or admin can update/delete
      allow update: if isSignedIn() && (
        isAdmin() || 
        (isCreator() && resource.data.get('creator_id', '') == request.auth.uid)
      );
      allow delete: if isAdmin();
      
      // Modules subcollection - nested under courses
      match /modules/{moduleId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && (isCreator() || isAdmin());
        
        // Sessions subcollection - nested under modules
        match /sessions/{sessionId} {
          allow read: if isSignedIn();
          allow write: if isSignedIn() && (isCreator() || isAdmin());
          
          // Exercises subcollection - nested under sessions
          match /exercises/{exerciseId} {
            allow read: if isSignedIn();
            allow write: if isSignedIn() && (isCreator() || isAdmin());
            
            // Sets subcollection - nested under exercises
            match /sets/{setId} {
              allow read: if isSignedIn();
              allow write: if isSignedIn() && (isCreator() || isAdmin());
            }
          }
        }
      }
    }
    
    // ============================================
    // USER PROGRESS & DATA (LEGACY - TO BE REMOVED)
    // ============================================
    
    // User progress - supports userId_courseId pattern
    // Allow if document ID starts with user's ID
    match /user_progress/{docId} {
      allow read: if isSignedIn() && (
        docId == request.auth.uid ||
        docId.matches('^' + request.auth.uid + '_.*')
      );
      allow write: if isSignedIn() && (
        docId == request.auth.uid ||
        docId.matches('^' + request.auth.uid + '_.*') ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Completed sessions - supports userId_courseId_timestamp pattern
    match /completed_sessions/{docId} {
      allow read: if isSignedIn() && (
        docId.matches('^' + request.auth.uid + '_.*') ||
        (resource != null && resource.data.userId == request.auth.uid)
      );
      allow create: if isSignedIn() && (
        docId.matches('^' + request.auth.uid + '_.*') ||
        request.resource.data.userId == request.auth.uid
      );
      allow update, delete: if isSignedIn() && (
        docId.matches('^' + request.auth.uid + '_.*') ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // ============================================
    // APP RESOURCES
    // ============================================
    
    // Disciplines - all authenticated users can read
    match /disciplines/{disciplineId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    // App resources - publicly readable (needed for asset bundle initialization before auth)
    // These are public app assets (videos/images), not sensitive user data
    match /app_resources/{resourceId} {
      allow read: if true; // Public read access for app assets
      allow write: if isAdmin();
    }
    
    // ============================================
    // PURCHASES
    // ============================================
    
    // Purchases - users can create their own, admins can read all
    match /purchases/{purchaseId} {
      allow read: if isSignedIn() && (
        isAdmin() ||
        resource.data.user_id == request.auth.uid
      );
      allow create: if isSignedIn() && request.resource.data.user_id == request.auth.uid;
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // ACCOUNT DELETION FEEDBACK
    // ============================================
    
    // Account deletion feedback - users can create their own feedback, admins can read all
    match /account_deletion_feedback/{feedbackId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isAdmin();
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // CREATOR MEDIA (personal folder for images/videos)
    // ============================================
    match /creator_media/{creatorId} {
      allow read, write: if isSignedIn() && request.auth.uid == creatorId;
      match /files/{fileId} {
        allow read, write: if isSignedIn() && request.auth.uid == creatorId;
      }
    }

    // ============================================
    // CALL BOOKING: Creator availability (time slots)
    // ============================================
    match /creator_availability/{creatorId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && request.auth.uid == creatorId;
      allow delete: if isSignedIn() && request.auth.uid == creatorId;
    }

    // Call bookings (sales call / one-on-one slot)
    match /call_bookings/{bookingId} {
      allow read: if isSignedIn() && (
        resource.data.creatorId == request.auth.uid ||
        resource.data.clientUserId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isSignedIn() && request.resource.data.clientUserId == request.auth.uid;
      allow update: if isSignedIn() && (
        resource.data.creatorId == request.auth.uid ||
        resource.data.clientUserId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if false;
    }

    // ============================================
    // NUTRITION (creator library, assignments, user diary)
    // ============================================
    match /creator_nutrition_library/{creatorId}/meals/{mealId} {
      allow read, write: if isSignedIn() && request.auth.uid == creatorId;
    }
    match /creator_nutrition_library/{creatorId}/plans/{planId} {
      allow read, write: if isSignedIn() && request.auth.uid == creatorId;
    }

    match /nutrition_assignments/{assignmentId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        resource.data.assignedBy == request.auth.uid ||
        isAdmin()
      );
      allow create: if isSignedIn() && isCreator() && request.resource.data.assignedBy == request.auth.uid;
      allow update, delete: if isSignedIn() && (
        resource.data.assignedBy == request.auth.uid || isAdmin()
      );
    }

    match /users/{userId}/diary/{entryId} {
      allow read, write: if isOwner(userId);
      allow read: if creatorHasClientAccess(userId);
    }

    // Client nutrition plan content: per-assignment copy (doc id = assignmentId).
    // Client can read their copy; creator (assignedBy) can read/write.
    match /client_nutrition_plan_content/{assignmentId} {
      allow read: if isSignedIn() && (
        get(/databases/$(database)/documents/nutrition_assignments/$(assignmentId)).data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/nutrition_assignments/$(assignmentId)).data.assignedBy == request.auth.uid ||
        isAdmin()
      );
      allow create, update, delete: if isSignedIn() && (
        get(/databases/$(database)/documents/nutrition_assignments/$(assignmentId)).data.assignedBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================
    // DEFAULT RULE (Fallback for any other collections)
    // ============================================
    // CREATOR FEEDBACK (suggestions / bug reports)
    // ============================================
    match /creator_feedback/{feedbackId} {
      allow create: if isSignedIn() && isCreator() && request.resource.data.creatorId == request.auth.uid;
      allow read, update, delete: if isAdmin();
    }

    // ============================================
    
    // Allow authenticated users to access other collections
    // This provides flexibility for development while still requiring authentication
    match /{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}
